{% extends 'base.html' %}
{% block title %}Fit {{ project.project_title }}{% endblock title %}

{% load staticfiles%}

{% block content %}

    {% if user.is_authenticated %}

        {% if tutorial and xuser_tutorial %}
            <div class="announcement">
                <h3>Data Analysis</h3>
                <p>This page is where you can preform your actual data analysis.</p>
                <ul>
                    <li><strong>The fit button</strong> saves the current parameter set and generates a new one, based on the model you're using. It then displays a red "line of best fit" to show you how your fit did.</li>
                    <li><strong>Fit Statistics</strong> will give you more detailed information about the calculations competed during the fitting process.</li>
                    <li><strong>Show Probabilities</strong> will display both the volumer probabilities and the scattering density profiles for each dataset</li>
                    <li><strong>Downloading your data</strong> will output your fit data values along with the fit statistics. When you're looking at the fit or the fit statistics, you'll get the fit data. When you're looking at the probabilities and SDP, you'll get the SDP data.</li>
                </ul>
                <p>
                    <form id="inline" method="POST">
                        {% csrf_token %}
                        <button type="submit" name="dismiss_this" style="margin-right: 15px;">Temporarily dismiss <strong>just this page's</strong> tutorials</button>
                    </form>
                    <form id="inline" method="POST">
                        {% csrf_token %}
                        <button type="submit" name="dismiss_all">Permanently dismiss <strong>all</strong> tutorials</button>
                    </form>
                </p>
            </div>
        {% endif %}

    <div class="content-box">
        
        <div id="left">

            <h1><a href="{% url 'viewer:project_detail' project_id=project.id %}">{{project.project_title}}</a> \ <a href="{% url 'viewer:sample_detail' project_id=project.id sample_id=sample.id %}">{{ sample.sample_title }}</a> \ {{ parameter.name }}</h1>

        </div>
        
        <div class="fit_buttons" id="right">

            {% if parameter.fit_report %}
                {% if show_stats %}
                    <form id="inline" method="POST">
                        {% csrf_token %}
                        <button type="submit" name="graphs">Show Fit</button>
                    </form>
                {% else %}
                    <form id="inline" method="POST">
                        {% csrf_token %}
                        <button type="submit" name="statistics">Show Statistics</button>
                    </form>
                {% endif %}

                {% if show_probs %}
                    <form id="inline" method="POST">
                        {% csrf_token %}
                        <button type="submit" name="graphs">Show Fit</button>
                    </form>
                    <form id="inline" method="POST">
                        {% csrf_token %}
                        <button type="submit" name="sdp_download">Download SDP Data</button>
                    </form>
                {% else %}
                    <form id="inline" method="POST">
                        {% csrf_token %}
                        <button type="submit" name="probabilities">Show Probabilities</button>
                    </form>
                    <form id="inline" method="POST">
                        {% csrf_token %}
                        <button type="submit" name="fit_download">Download Fit Data</button>
                    </form>
                {% endif %}
            {% endif %}

            {% if data_exists %}
                <form id="inline" method="POST">
                    {% csrf_token %}
                    <button class="success" type="submit" name="fit"><h2 id="no-margins">Fit!</h2></button>
                </form>
            {% endif %}

        </div>
    </div>

    {% if tutorial and xuser_tutorial %}
        <div class="announcement">
            <p>Your parameters are shown on the left. Each one can be locked (so that it doesn't vary during the fit), changed, or constrained (by chainging it's upper and lower bounds).</p>
            <h4>NOTE: You must hit "update" (at the bottom of the parameter section) every time you make a change. If you don't, those changes will not be reflected when you fit.</h4>
        </div>
    {% endif %}

    {% if not data_exists %}
        <div class="error">
            <h4>No datasets have been loaded... please add at least one before attempting to fit.</h4>
            <p><a href="{% url 'viewer:data_upload' project_id=project.id sample_id=sample.id %}">Click Here</a> to add a dataset.</p>
        </div>
    {% endif %}

    {% if parameter_update_form.errors %}
        <div class="error">
            <h4>Please correct the following errors before proceeding:</h4>
            <ul>
                {% for key, value in parameter_update_form.errors.items %}
                    <li>{{ value }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    {% if zero_parameter %}
        <div class="error">
            <h4>One or more of your parameters is zero:</h4>
            <p>An error has occured, and one or more critical parameters (Vh, Vc, Vt or Sigma) is zero. This prevents the SDP graphs from being properly generated.</p>
            <p>Please check your results.</p>
        </div>
    {% endif %}

    {% if "[[Correlations]] (unreported correlations are < 0.100)" not in parameter.fit_report and show_stats %}
        <div class="announcement">
            <p>No correlations are reported - most likely because they are smaller than 0.100, or possibly because there is some error preventing them from being calculated.</p>
        </div>
    {% endif %}

    <div class="content-box parameters" id="left">

        <form method="POST" enctype="multipart/form-data">

            {% csrf_token %}

            <table id="center" class="form_box">

                <!-- Include SFF? -->
                <tr>
                    <td><h4 id="inline">SFF?</h4> {{ parameter_update_form.separated }} <span tooltip tooltip-right tooltip-content="Include the separated form factor" ><img id="no-margins" src="{% static "viewer/images/what.png" %}" width="15px" alt="question icon"></span></td>
                </tr>
                <tr>
                    <td colspan="2"><hr /></td>
                </tr>

                {% if project.model_type == "SM" %}
                    {% include "viewer/fits/symfit_form.html" %}
                {% elif project.model_type == "AS" %}
                    {% include "viewer/fits/asymfit_form.html" %}
                {% endif %}

                <!-- SIG -->
                <tr>
                    <td>
                        <h4 id="inline">&sigma;</h4>
                        {% if not parameter.sigma_lock %}
                                <img id="no-margins" src="{% static "viewer/images/lockopen.png" %}" width="15px" alt="lock icon">
                            {% else %}
                                <img id="no-margins" src="{% static "viewer/images/lockclosed.png" %}" width="15px" alt="lock icon">
                            {% endif %}
                        {{ parameter_update_form.sigma_lock }}
                        <span tooltip tooltip-right tooltip-content="Sigma"><img id="no-margins" src="{% static "viewer/images/what.png" %}" width="15px" alt="question icon">
                    </td>
                </tr>
                <tr>
                    <td>
                        <img id="no-margins" src="{% static "viewer/images/up.png" %}" width="20px" alt="up icon">
                        {{ parameter_update_form.sigma_upperbound }}
                    </td>
                </tr>
                <tr>
                    <td>{{ parameter_update_form.sigma }}</td>
                </tr>
                <tr>
                    <td>
                        <img id="no-margins" src="{% static "viewer/images/down.png" %}" width="20px" alt="down icon">
                        {{ parameter_update_form.sigma_lowerbound }}
                    </td>
                </tr>
                <tr>
                    <td colspan="2"><hr /></td>
                </tr>

                {% if parameter.separated %}

                    <!-- AVR -->
                    <tr>
                        <td>
                            <h4 id="inline">R<sub>m</sub></h4>
                            {% if not parameter.average_vesicle_radius_lock %}
                                <img id="no-margins" src="{% static "viewer/images/lockopen.png" %}" width="15px" alt="lock icon">
                            {% else %}
                                <img id="no-margins" src="{% static "viewer/images/lockclosed.png" %}" width="15px" alt="lock icon">
                            {% endif %}
                            {{ parameter_update_form.average_vesicle_radius_lock }}
                            <span tooltip tooltip-right tooltip-content="Average vesicle radius (nm)"><img id="no-margins" src="{% static "viewer/images/what.png" %}" width="15px" alt="question icon">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <img id="no-margins" src="{% static "viewer/images/up.png" %}" width="20px" alt="up icon">
                            {{ parameter_update_form.average_vesicle_radius_upperbound }}
                        </td>
                    </tr>
                    <tr>
                        <td>{{ parameter_update_form.average_vesicle_radius }}</td>
                    </tr>
                    <tr>
                        <td>
                            <img id="no-margins" src="{% static "viewer/images/down.png" %}" width="20px" alt="down icon">
                            {{ parameter_update_form.average_vesicle_radius_lowerbound }}
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2"><hr /></td>
                    </tr>

                    <!-- RSP -->
                    <tr>
                        <td><h4 id="inline">&sigma;<sub>SF</sub></h4>
                            {% if not parameter.relative_size_lock %}
                                <img id="no-margins" src="{% static "viewer/images/lockopen.png" %}" width="15px" alt="lock icon">
                            {% else %}
                                <img id="no-margins" src="{% static "viewer/images/lockclosed.png" %}" width="15px" alt="lock icon">
                            {% endif %}
                            {{ parameter_update_form.relative_size_lock }}
                            <span tooltip tooltip-right tooltip-content="Relative vesicle size"><img id="no-margins" src="{% static "viewer/images/what.png" %}" width="15px" alt="question icon">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <img id="no-margins" src="{% static "viewer/images/up.png" %}" width="20px" alt="up icon">
                            {{ parameter_update_form.relative_size_upperbound }}
                        </td>
                    </tr>
                    <tr>
                        <td>{{ parameter_update_form.relative_size }}</td>
                    </tr>
                    <tr>
                        <td>
                            <img id="no-margins" src="{% static "viewer/images/down.png" %}" width="20px" alt="down icon">
                            {{ parameter_update_form.relative_size_lowerbound }}
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2"><hr /></td>
                    </tr>

                {% else %}

                    <!-- AVR -->
                    <tr class="hidden">
                        <td><h4>R<sub>m</sub> {{ parameter_update_form.average_vesicle_radius_lock }}</h4></td>
                    </tr>
                    <tr class="hidden">
                        <td>{{ parameter_update_form.average_vesicle_radius_upperbound }}</td>
                    </tr>
                    <tr class="hidden">
                        <td>{{ parameter_update_form.average_vesicle_radius }}</td>
                    </tr>
                    <tr class="hidden">
                        <td>{{ parameter_update_form.average_vesicle_radius_lowerbound }}</td>
                    </tr>
                    <tr class="hidden">
                        <td colspan="2"><hr /></td>
                    </tr>

                    <!-- RSP -->
                    <tr class="hidden">
                        <td><h4>&sigma;<sub>SF</sub> {{ parameter_update_form.relative_size_lock }}</h4></td>
                    </tr>
                    <tr class="hidden">
                        <td>{{ parameter_update_form.relative_size_upperbound }}</td>
                    </tr>
                    <tr class="hidden">
                        <td>{{ parameter_update_form.relative_size }}</td>
                    </tr>
                    <tr class="hidden">
                        <td>{{ parameter_update_form.relative_size_lowerbound }}</td>
                    </tr>
                    <tr class="hidden">
                        <td colspan="2"><hr /></td>
                    </tr>

                {% endif %}

                
                {% if project.model_type == "SM" %}
                    {% include "viewer/fits/symfit_form_thick.html" %}
                {% elif project.model_type == "AS" %}
                    {% include "viewer/fits/asymfit_form_thick.html" %}
                {% endif %}

                <tr>
                    <td colspan="2" style="text-align: center;">
                        <button type="submit" name="parameter_update">Update</button>
                    </td>
                </tr>
            </table>
        </form>

    </div>

    <div id="container">

        {% if tutorial and xuser_tutorial %}
            <div class="announcement">
                <p>Each dataset is graphed and displayed here, separated by type. To the right of each dataset, you can see parameters specific to that set. You can change these values to help improve the preformance of the joint fit on a particular dataset.</p>
            </div>
        {% endif %}

        {% if show_stats %}

            <div class="content-box">
                <h2>Calculated Parameters:</h2>
                {% if project.model_type == "SM" %}
                    {% include "viewer/fits/symfit_form_calcvals.html" %}
                {% elif project.model_type == "AS" %}
                    {% include "viewer/fits/asymfit_form_calcvals.html" %}
                {% endif %}

                <h2>Fit Statistics:</h2>
                {% for i in parameter.fit_report %}

                    {% if i == "[[Fit Statistics]]" or i == "[[Variables]]" or i == "[[Correlations]] (unreported correlations are < 0.100)" %}
                        <h3>{{ i }}</h3>
                    {% else %}
                        <p class="indent">{{ i }}</p>
                    {% endif %}

                {% endfor %}
            </div>

        {% elif show_probs %}

            <div class="content-box">
                <h2>Probability Distribution</h2>
            </div>
            <div class="content-box">
                <p></p>
                <div id="left" class="graph-box">
                    {{prob_graph|safe}}
                </div>
            </div>
            

            <div class="content-box">
                <h2>Scattering Denisty Profiles</h2>
            </div>
                {% for xray_sdp_graph in xray_sdp_graphs %}
                    <div class="content-box">
                        <p></p>
                        <div id="left" class="graph-box">
                            {{xray_sdp_graph|safe}}
                        </div>
                    </div>
                {% endfor %}
                {% for neutron_sdp_graph in neutron_sdp_graphs %}
                    <div class="content-box">
                        <p></p>
                        <div id="left" class="graph-box">
                            {{neutron_sdp_graph|safe}}
                        </div>
                    </div>
                {% endfor %}

        {% else %}

            <div class="content-box">
                <h2>X-Ray Data</h2>
            </div>
                {% for xray_graph, xray_range, xray_scale, xray_data in xray_graphs_and_forms %}

                {% if xray_range.errors or xray_scale.errors %}
                    <div class="error">
                        <h4>Please correct the following errors before proceeding:</h4>
                        <ul>
                            {% for key, value in xray_range.errors.items %}
                                <li>{{ value }}</li>
                            {% endfor %}
                        </ul>
                        <ul>
                            {% for key, value in xray_scale.errors.items %}
                                <li>{{ value }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                <div class="content-box">
                    <p></p>
                    <div id="left" class="graph-box">
                        {{xray_graph|safe}}
                    </div>

                    <div>
                        <form method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            <table id="left" class="form_box parameters">
                                <tr>
                                    <td>
                                        <span tooltip tooltip-left tooltip-content="Data scale"><img id="no-margins" src="{% static "viewer/images/what.png" %}" width="15px" alt="question icon">
                                        <h4 id="inline">SC</h4>
                                        {% if not xray_data.scale_lock %}
                                            <img id="no-margins" src="{% static "viewer/images/lockopen.png" %}" width="15px" alt="lock icon">
                                        {% else %}
                                            <img id="no-margins" src="{% static "viewer/images/lockclosed.png" %}" width="15px" alt="lock icon">
                                        {% endif %}
                                        {{ xray_scale.scale_lock }}
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <img id="no-margins" src="{% static "viewer/images/up.png" %}" width="20px" alt="up icon">
                                        {{ xray_scale.scale_upperbound }}
                                    </td>
                                </tr>
                                <tr>
                                    <td>{{ xray_scale.scale }}</td>
                                </tr>
                                <tr>
                                    <td>
                                        <img id="no-margins" src="{% static "viewer/images/down.png" %}" width="20px" alt="down icon">
                                        {{ xray_scale.scale_lowerbound }}
                                    </td>
                                </tr>
                                <tr>
                                    <td><hr /></td>
                                </tr>
                                <tr>
                                    <td>
                                        <span tooltip tooltip-left tooltip-content="Data background"><img id="no-margins" src="{% static "viewer/images/what.png" %}" width="15px" alt="question icon">
                                        <h4 id="inline">BG</h4>
                                        {% if not xray_data.background_lock %}
                                            <img id="no-margins" src="{% static "viewer/images/lockopen.png" %}" width="15px" alt="lock icon">
                                        {% else %}
                                            <img id="no-margins" src="{% static "viewer/images/lockclosed.png" %}" width="15px" alt="lock icon">
                                        {% endif %}
                                        {{ xray_scale.background_lock }}
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <img id="no-margins" src="{% static "viewer/images/up.png" %}" width="20px" alt="up icon">
                                        {{ xray_scale.background_upperbound }}
                                    </td>
                                </tr>
                                    <td>{{ xray_scale.background }}</td>
                                </tr>
                                <tr>
                                    <td>
                                        <img id="no-margins" src="{% static "viewer/images/down.png" %}" width="20px" alt="down icon">
                                        {{ xray_scale.background_lowerbound }}
                                    </td>
                                </tr>
                                <tr>
                                    <td><hr /></td>
                                </tr>
                                <tr>
                                    <td>
                                        <span tooltip tooltip-left tooltip-content="Restrict the q values on this dataset"><img id="no-margins" src="{% static "viewer/images/what.png" %}" width="15px" alt="question icon">
                                        <h4 id="inline">Max / Min</h4>
                                    </td>
                                </tr>
                                <tr>
                                    <tr>
                                        <td>
                                            <img id="no-margins" src="{% static "viewer/images/up.png" %}" width="20px" alt="up icon">
                                            {{ xray_range.max_value }}
                                        </td>
                                    </tr>
                                    <td>
                                        <img id="no-margins" src="{% static "viewer/images/down.png" %}" width="20px" alt="down icon">
                                        {{ xray_range.min_value }}
                                    </td>
                                </tr>
                                <tr>
                                    <td><hr /></td>
                                </tr>
                                <tr>
                                    <td style="text-align: center;">
                                        <button type="submit" name="{{xray_data.data_set_title}}" >Update</button>
                                    </td>
                                </tr>
                            </table>
                        </form>
                        <table id="left" class="form_box parameters">
                            <tr>
                                <td>
                                    <h3 id="inline">Structure Factor</h3>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                {% endfor %}

            <div class="content-box">
                <h2>Neutron Data</h2>
            </div>

                {% for neutron_graph, neutron_range, neutron_scale, neutron_data in neutron_graphs_and_forms %}

                {% if neutron_range.errors or neutron_scale.errors %}
                    <div class="error">
                        <h4>Please correct the following errors before proceeding:</h4>
                        <ul>
                            {% for key, value in neutron_range.errors.items %}
                                <li>{{ value }}</li>
                            {% endfor %}
                        </ul>
                        <ul>
                            {% for key, value in neutron_scale.errors.items %}
                                <li>{{ value }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                <div class="content-box">
                    <p></p>
                    <div id="left" class="graph-box">
                        {{neutron_graph|safe}}
                    </div>

                    <div>
                        <form method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            <table id="left" class="form_box parameters">
                                <tr>
                                    <td>
                                        <span tooltip tooltip-left tooltip-content="Data scale"><img id="no-margins" src="{% static "viewer/images/what.png" %}" width="15px" alt="question icon">
                                        <h4 id="inline">SC</h4>
                                        {% if not neutron_data.scale_lock %}
                                            <img id="no-margins" src="{% static "viewer/images/lockopen.png" %}" width="15px" alt="lock icon">
                                        {% else %}
                                            <img id="no-margins" src="{% static "viewer/images/lockclosed.png" %}" width="15px" alt="lock icon">
                                        {% endif %}
                                        {{ neutron_scale.scale_lock }}
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <img id="no-margins" src="{% static "viewer/images/up.png" %}" width="20px" alt="up icon">
                                        {{ neutron_scale.scale_upperbound }}
                                    </td>
                                </tr>
                                <tr>
                                    <td>{{ neutron_scale.scale }}</td>
                                </tr>
                                <tr>
                                    <td>
                                        <img id="no-margins" src="{% static "viewer/images/down.png" %}" width="20px" alt="down icon">
                                        {{ neutron_scale.scale_lowerbound }}
                                    </td>
                                </tr>
                                <tr>
                                    <td><hr /></td>
                                </tr>
                                <tr>
                                    <td>
                                        <span tooltip tooltip-left tooltip-content="Data background"><img id="no-margins" src="{% static "viewer/images/what.png" %}" width="15px" alt="question icon">
                                        <h4 id="inline">BG</h4>
                                        {% if not neutron_data.background_lock %}
                                            <img id="no-margins" src="{% static "viewer/images/lockopen.png" %}" width="15px" alt="lock icon">
                                        {% else %}
                                            <img id="no-margins" src="{% static "viewer/images/lockclosed.png" %}" width="15px" alt="lock icon">
                                        {% endif %}
                                        {{ neutron_scale.background_lock }}
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <img id="no-margins" src="{% static "viewer/images/up.png" %}" width="20px" alt="up icon">
                                        {{ neutron_scale.background_upperbound }}
                                    </td>
                                </tr>
                                    <td>{{ neutron_scale.background }}</td>
                                </tr>
                                <tr>
                                    <td>
                                        <img id="no-margins" src="{% static "viewer/images/down.png" %}" width="20px" alt="down icon">
                                        {{ neutron_scale.background_lowerbound }}
                                    </td>
                                </tr>
                                <tr>
                                    <td><hr /></td>
                                </tr>
                                <tr>
                                    <td>
                                        <span tooltip tooltip-left tooltip-content="Restrict the q values on this dataset"><img id="no-margins" src="{% static "viewer/images/what.png" %}" width="15px" alt="question icon">
                                        <h4 id="inline">Max / Min</h4>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <img id="no-margins" src="{% static "viewer/images/up.png" %}" width="20px" alt="up icon">
                                        {{ neutron_range.max_value }}
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <img id="no-margins" src="{% static "viewer/images/down.png" %}" width="20px" alt="down icon">
                                        {{ neutron_range.min_value }}
                                    </td>
                                </tr>
                                <tr>
                                    <td><hr /></td>
                                </tr>
                                <tr>
                                    <td style="text-align: center;">
                                        <button type="submit" name="{{neutron_data.data_set_title}}" >Update</button>
                                    </td>
                                </tr>
                            </table>
                        </form>
                        <table id="left" class="form_box parameters">
                            <tr>
                                <td>
                                    <h3 id="inline">Structure Factor</h3>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                {% endfor %}

        {% endif %}

    </div>

    {% else %}

    <div class="content-box">
        <h1>You're not logged in</h1>

        <p>To view this page, please <a href="{% url 'login' %}">login</a>.</p>
    </div>

    {% endif %}
{% endblock content %}